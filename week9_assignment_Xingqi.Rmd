---
title: "LinearNonLinear_week9_assignment_Xingqi"
author: "Xingqi"
date: "March 4, 2015"
output: pdf_document
---

The data in the file HIV_Protease.csv show part of the analysis of HIV enzyme called Protease. Protease plays important role in spreading the virus and is often targeted by drugs trying to contain the virus in patient.

Because HIV virus mutates a lot it develops resistance to drugs when codons in certain positions in the sequence enzyme get replaced by other codons.

Read the data.

```{r}
HIV.Protease.Data<-read.csv(file="HIV_Protease.csv",header=TRUE,sep=",")
HIV.Protease.Data<-as.data.frame(HIV.Protease.Data)
head(HIV.Protease.Data)
```

The first column shows if the effect of the treatment on number of patients: 0 means no effect (resistance to drug) and 1 means successful treatment.

The second column shows the virus load, i.e. some measure of home many viruses are in the patient’s body before the treatment. The last column shows the symbol in the second position (CODON_2) of HIV Protease which each patient has.

Show all possible expressions of CODON_2 and how many times they appear in the last column.

```{r}
table(HIV.Protease.Data$CODON_2)
```

Show the levels of VL that appear simultaneously with expression “caa” and look at the histogram of VL values.

```{r}
HIV.Protease.Data.caa.VL<-subset(HIV.Protease.Data$VL,HIV.Protease.Data$CODON_2=="caa")
hist(HIV.Protease.Data.caa.VL)
```

**The histogram of VL of HIV.protease.Data.caa.VL is positively skewed.**

Do the same for the expression “cag”

```{r}
HIV.Protease.Data.cag.VL<-subset(HIV.Protease.Data$VL,HIV.Protease.Data$CODON_2=="cag")
hist(HIV.Protease.Data.cag.VL)
```

**The histogram of VL of HIV.protease.Data.cag.VL is also positively skewed. But this histogram of VL load is different from the above histogram of HIV.protease.Data.caa.VL.**

Compare the means.

```{r}
c(mean(HIV.Protease.Data.cag.VL),mean(HIV.Protease.Data.caa.VL))
```

The means of VL in these two groups are close to each other.

Fit linear model

```{r}
lm.CODON_2.VL<-lm(VL~CODON_2, data=HIV.Protease.Data)
summary(lm.CODON_2.VL)
AIC(lm.CODON_2.VL)
anova(lm.CODON_2.VL)
```

The means do not seem to be different. Explain why.

**lm.CODON_2.VL uses VL as dependent varibale and CODON_2 as a fixed effect. From summary of lm.CODON_2.VL, the intercept is significant while all of the slopes are not significant. The R-squared value is very low, which means this model doesn't fit well with dataset.**

**Using anova, the p value of CODON_2 is not significant,which means the null hypothesis is retained. Using CODON_2 as fixed effect, the lm.CODON_2.VL model is to test whether the group means in different codon groups are equal. The means of VL load before treatment in different groups of CODON_2 are similar although the frequencies of VL load in different groups are different. So I cannot observe the difference of VL in different codon groups using lm.CODON_2.VL model.**

Fit the model with random effect.

```{r}
library(lme4)
Codon2<-(HIV.Protease.Data$CODON_2=="caa")*1
lm.CODON_2.VL.Mixed<-lmer(VL~1+(1|Codon2), data=HIV.Protease.Data)
summary(lm.CODON_2.VL.Mixed)
AIC(lm.CODON_2.VL.Mixed)
```


Compare the fit with model with fixed effect.

** lm.CODON_2.VL.Mixed uses VL as dependent variable and Condon2 as random effect. lm.CODON_2.VL uses VL as dependent variable and CODON_2 as a fixed effect. The comparision of these two models are as belows.**

**The AIC values in these three models are compared as belows.**

```{r}
rbind(lm.CODON_2.VL.Mixed=AIC(lm.CODON_2.VL.Mixed),
lm.CODON_2.VL=AIC(lm.CODON_2.VL))
```

** The AIC of this model lm.CODON_2.VL.Mixed is higher than AIC value of lm.CODON_2.VL. So the fit of lm.CODON_2.VL is slightly better than lm.CODON_2.VL.Mixed. **

**The residuals in these two models are compared as below.**

**QQ-plot**

```{r}
par(mfrow=c(1,2))
qqnorm(residuals(lm.CODON_2.VL.Mixed),main="lm.CODON_2.VL.Mixed")
qqline(residuals(lm.CODON_2.VL.Mixed))
qqnorm(residuals(lm.CODON_2.VL),main="lm.CODON_2.VL")
qqline(residuals(lm.CODON_2.VL))
par(mfrow=c(1,1))
```

The residuals in lm.CODON_2.VL.Mixed and lm.CODON_2.VL share the similar patterns. Most of residuals in these two models fit well with theoretical line only with deviation at both ends.

**Sigma of residuals**

```{r}
rbind(lm.CODON_2.VL.Mixed=sd(summary(lm.CODON_2.VL.Mixed)$residuals),
lm.CODON_2.VL=summary(lm.CODON_2.VL)$sigma)
```

The sd of residuals in lm.CODON_2.VL is the lower than RMSE of residuals in lm.CODON_2.VL.Effect.

Taken together, the fit of lm.CODON_2.VL is slightly better than lm.CODON_2.VL.Mixed. **

Fit logistic regression Resp~VL

```{r}
glm.CODON_2.VL<-glm(Resp~VL, binomial,data=HIV.Protease.Data)
summary(glm.CODON_2.VL)
```

**Both intercept and slope are statistically significant. The residual deviance is lower than the deviance in null model. The slope of VL is 1.4193, which means that higher VL lead to higher probability of treatment success.**

```{r}
AIC(glm.CODON_2.VL)
```

```{r}
matplot(1:length(HIV.Protease.Data$Resp),cbind(HIV.Protease.Data$Resp,glm.CODON_2.VL$fitted.values),pch=16)
```

**From matplot, the points of fitted values of glm.CODON_2.VL are more condensed around 0 in the failed patients. There is certain response between VL fitted.values and Resp.**


```{r}
head(cbind(HIV.Protease.Data$Resp,glm.CODON_2.VL$fitted.values))
```

Fit model with CODON_2 expression as predictor.

```{r}
library(MASS)
library(nlme)
```


```{r}
glm.CODON_2.LV<-glmmPQL(Resp~VL, random=~1|Codon2, binomial,data=HIV.Protease.Data)
summary(glm.CODON_2.LV)
```

**Both slope and intercept of fixed effector are significant. The slope of VL is positive which means that higher VL load leads to higher probability of success. The slope of random effect condon 2 is positive. This mean the mutation of Codon2 leads to increasing probability of fail.**

```{r}
AIC(glm.CODON_2.LV)
names(glm.CODON_2.LV)
```

```{r}
plot(predict(glm.CODON_2.LV,type="response"))
```

```{r}
matplot(1:length(HIV.Protease.Data$Resp),cbind(HIV.Protease.Data$Resp,predict(glm.CODON_2.LV,type="response")),pch=16)
```

**From the matplot, I can observe points of fitted values of glm.CODON_2.LV is very condensed in the failed patients. This means certain response between predicted value of glm.CODON_2.LV and Resp. A lots of fitted Resp are close to the actual Resp value and the response of model is stronger than model of glm.CODON_2.VL in last step. The mutations in CONDON_2 contribute to the fail of treatment. **

```{r}
head(cbind(HIV.Protease.Data$Resp,predict(glm.CODON_2.LV,type="response")))
```

