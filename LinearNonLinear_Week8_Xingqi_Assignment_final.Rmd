---
title: "LinearNonLinear_Week8_Assignment_Xingqi"
author: "Xingqi"
date: "February 25, 2015"
output: pdf_document
---

This project helps understanding fixed and random effects.
The project is due one week from the date shown in the title portion of this document at 11:59 pm.
This project is individual.
Look at the sample in the file LinearModelCase1.csv. Below nSample is the length of the sample imported from the file. The first 10 rows and the X-Y plot are:

```{r}
MarketingData<-read.csv(file="MarketingExperiment.csv",header=TRUE,sep=",")
MarketingData<-as.data.frame(MarketingData)
MarketingData[1:10,]
```


```{r}
plot(MarketingData$Time,MarketingData$Probability, type="p",pch=19,xlab="Time",ylab="Probability")
```


**The scatterplot shows that the data forms two parallel clusters in the graph.**

Estimate linear model using function lm look at the output of the function

```{r}
MarketingData.EstimatedLinearModel<-lm(Probability~Time,data=MarketingData)
names(MarketingData.EstimatedLinearModel)
```


```{r}
MarketingData.EstimatedLinearModel$coefficients
```

, and the summary of it

```{r}
summary(MarketingData.EstimatedLinearModel)
```


```{r}
names(summary(MarketingData.EstimatedLinearModel))
```

Interpret the results in the output.

**The independent variable in this model is Time and the dependent variable is Probability.  From summary of MarketingData, the R-squared value is 0.8231, which means the fit of model is good. The slope of time is statistically significant. However, the value of intercept in the model is close to 0 and the p-value of this intercept is not statistically significant. So I need to further check the distribution of residulas of this model.**

Observe the residuals

```{r}
EstimatedResiduals<-MarketingData.EstimatedLinearModel$residuals
plot(MarketingData$Time,EstimatedResiduals)
```

**The residuals of this model form two clusters in the graph. The seperation line of these two clusters is close to the value of 0.**

, and their probability density in comparison with the normal density

```{r}
Probability.Density.Residuals<-density(EstimatedResiduals)
plot(Probability.Density.Residuals,ylim=c(0,10))
lines(Probability.Density.Residuals$x,dnorm(Probability.Density.Residuals$x,mean=mean(EstimatedResiduals),sd=sd(EstimatedResiduals)),col="red")
qqnorm(EstimatedResiduals)
qqline(EstimatedResiduals)

```

What do you conclude from the analysis of residuals?

**From the scatterplot, the residuals form two clusters and the seperation line of these two clusters is close to the value of 0. In the probability density graph, the curve of residual desities is clearly different from standard normal distribution curve but forms two clear seperated peeks. The QQ plot show relative strong deviation from theoretical line at both ends. These anlaysis of residuals demonstrate that the residuals of this model is not normally distributed and the residuals form two distinct clusters. This result suggest the MarketingData.EstimatedLinearModel is not optimal model to explain the dataset. I need to improve modeling by clustering the dataset or adding additional effect to the model.**

Add the fixed effect based on gender.

```{r}
MarketingData.LinearModel.Gender<-lm(Probability~Time+Gender,data=MarketingData)
Residuals.model2<-MarketingData.LinearModel.Gender$residuals
plot(MarketingData$Time,Residuals.model2)
Density.Residuals.model2 <- density(Residuals.model2)
plot(Density.Residuals.model2,ylim=c(0,20))
lines(Density.Residuals.model2$x, dnorm(Density.Residuals.model2$x, mean=mean(Residuals.model2), sd=sd(Residuals.model2)),col="red")
qqnorm(Residuals.model2)
qqline(Residuals.model2)
```

**The residuals of MarketingData.LinearModel.Gender are graphed in scatterplot and density plot above. In scatterplot, the residuals of model don't show clear cluster pattern anymore. The density curve of residuals is not completely overlapping with smooth normal distribution but the overall pattern of density curve is close to the normal distribution. The QQ-plot of residuals is very close to theoretical line.**

Compare the two summaries.

```{r}
summary(MarketingData.LinearModel.Gender)
summary(MarketingData.EstimatedLinearModel)
```



** Three parameters in the MarketingData.LinearModel.Gender model, Intercept, slope of Time and slope of GenderM, are all statistically significant. The slope of Time is positive, which means that Time is positive correlated with the probability. The slope of GenderM is negative, which indicate that Male have lower probability than the Female. The slope values of Time in MarketingData.LinearModel.Gender model and MarketingData.EstimatedLinearModel are very close. However the value of intercept in MarketingData.EstimatedLinearModel is close to 0 and the p-value of the intercept is not statistically significant. **

**The R-squared value in MarketingData.LinearModel.Gender with gender as fixed effect is higher than the R-squared value in MarketingData.EstimatedLinearModel. This means the MarketingData.LinearModel.Gender fit with dataset better than MarketingData.EstimatedLinearModel. **

**All above comparision concludes that the MarketingData.LinearModel.Gender is a better model to explain the dataset than  MarketingData.EstimatedLinearModel.**

Learn how to fit the model using lmer() from lme4

First use the simplest random effects model with Time as output and Gender as the only random effect.

```{r message=FALSE,warning=FALSE}
library(lme4)
```


```{r}
MarketingData.Time.Random.Effect<-lmer(Time~1+(1|Gender),data=MarketingData)
summary(MarketingData.Time.Random.Effect)
```

**The dependent variable in this model is Time. There is no independent variable in the model while Gender is used as a random effect in this model. The variance within the gender groups is 6.341992 and the variance between the gender groups is 0.006464. The variance within the gender groups is much larger than the variance between gender groups.The serial correlation of random effect is 0.006464/( 6.341992+0.006464)=0.0010182.**

One way of thinking about the variances returned by the summary of lmer() is: residual variance is the variance within the groups and each random effect variance is the variance between the groups.

Look at other fields in lmer() object.

```{r}
names(summary(MarketingData.Time.Random.Effect))
```


```{r}
summary(MarketingData.Time.Random.Effect)$coefficients
```


```{r}
summary(MarketingData.Time.Random.Effect)$sigma
```

Now apply lmer() to fit the model with one predictor Rime and one random effect based on Gender

```{r}
MarketingData.Probability.Random.Effect<-lmer(Probability ~ Time + (1 | Gender),data=MarketingData)
summary(MarketingData.Probability.Random.Effect)
```

**The MarketingData.Probability.Random.Effect model uses Probability as dependent variable, Time as independent variable and Gender as random effect. The variance within the gender groups is 0.0006184 and the variance between the gender groups is 0.0029805. The variance within the gender groups is smaller than the variance between gender groups. This model explain the variance within the gender groups very well.There are slightly negative correlation between Time and Gender. The serial correlation of random effect is 0.0029805/(0.0029805+0.0006184)=0.8281697.**

Compare the summaries and residuals of MarketingData.Probability.Random.Effect the linear model Probability~Time.

**The MarketingData.Probability.Random.Effect model uses Probability as a dependent variable, Time as an independent variable and Gender as a random effect. The MarketingData.EstimatedLinearModel in the first part uses Probability as dependent variable and only Time as independent variable. The MarketingData.LinearModel.Gender uses Probability as a dependent variable, Time as an independent variable and Gender as a fixed effect.  The comparision of these three models are as belows.**

**Coefficients**

```{r}
round(summary(MarketingData.Probability.Random.Effect)$coefficients,4)
round(summary(MarketingData.EstimatedLinearModel)$coefficients,4)
round(summary(MarketingData.LinearModel.Gender)$coefficients,4)
```


**The slope value of time in MarketingData.Probability.Random.Effect is equal to the slope of time in MarketingData.LinearModel.Gender. The slope values of time in these two models are also very close to the slope of time in MarketingData.EstimatedLinearModel. The p values of slope of Time in all three models are statistically significant. The intercept values in these three models are all different. The intercept in MarketingData.Probability.Random.Effect and MarketingData.LinearModel.Gender are statistically significant while the intercept in MarketingData.EstimatedLinearModel is not statistically significant. **

**The AIC values in these three models are compared as below.**

```{r}
rbind(MarketingData.EstimatedLinearModel=AIC(MarketingData.EstimatedLinearModel),
MarketingData.LinearModel.Gender=AIC(MarketingData.LinearModel.Gender),
MarketingData.Probability.Random.Effect=AIC(MarketingData.Probability.Random.Effect))
```

** From AIC value of these three models, the MarketingData.LinearModel.Gender has the lowest AIC value. This indicate that MarketingData.LinearModel.Gender is the best model among these three models to explain the dataset.**

**The residuals in these three models are compared as below.**

**QQ-plot**

```{r}
par(mfrow=c(1,3))
qqnorm(EstimatedResiduals,main="MarketingData.EstimatedLinearModel")
qqline(EstimatedResiduals)
qqnorm(Residuals.model2,main="MarketingData.LinearModel.Gender")
qqline(Residuals.model2)
qqnorm(resid(MarketingData.Probability.Random.Effect),main="MarketingData.Probability.Random.Effect")
qqline(resid(MarketingData.Probability.Random.Effect))
par(mfrow=c(1,1))
```

The residuals in MarketingData.Probability.Random.Effect and MarketingData.LinearModel.Gender share the similar patterns. Most of residuals in MarketingData.Probability.Random.Effect and MarketingData.LinearModel.Gender fit well with theoretical line. The residuals in MarketingData.EstimatedLinearModel deviate more from theoretical line at both ends than other two models.


**RMSE of residuals**

```{r}
rbind(MarketingData.EstimatedLinearModel=sqrt(mean((summary(MarketingData.EstimatedLinearModel)$residuals)^2)),
MarketingData.LinearModel.Gender=sqrt(mean((summary(MarketingData.LinearModel.Gender)$residuals)^2)),
MarketingData.Probability.Random.Effect=sqrt(mean((summary(MarketingData.Probability.Random.Effect)$residuals)^2)))
```

The RMSE of residuals in MarketingData.LinearModel.Gender is the lowest among these three models. The RMSE of residuals in MarketingData.Probability.Random.Effect is the largest among these three models.

**Sigma of residuals**

```{r}
rbind(MarketingData.EstimatedLinearModel=sd(summary(MarketingData.EstimatedLinearModel)$residuals),
MarketingData.LinearModel.Gender=sd(summary(MarketingData.LinearModel.Gender)$residuals),
MarketingData.Probability.Random.Effect=summary(MarketingData.Probability.Random.Effect)$sigma)
```

The sd of residuals in MarketingData.LinearModel.Gender is sligtly lower than the sigma value of residuals in
MarketingData.Probability.Random.Effect. The sd of residuals in MarketingData.EstimatedLinearModel is largest among these three models.

**The density of residuals in these three models are plotted as above and as below.**

```{r}
Residuals.model3<- resid(MarketingData.Probability.Random.Effect)
Density.Residuals.model3 <- density(Residuals.model3)
plot(Density.Residuals.model3,ylim=c(0,20))
lines(Density.Residuals.model3$x, dnorm(Density.Residuals.model3$x, mean=mean(Residuals.model3), sd=sd(Residuals.model3)),col="red")
```


**The density curve of residuals in MarketingData.Probability.Random.Effect is similar to density curve of residuals in MarketingData.LinearModel.Gender above. This curve is closer to normal distribution than MarketingData.EstimatedLinearModel.**

**In summary, the residuals in MarketingData.EstimatedLinearModel form two clusters. The residuals in MarketingData.LinearModel.Gender and MarketingData.Probability.Random.Effect share similar patterns, which is close to normally distributed. The AIC value,RMSE of residuals, and sd of resiudals in MarketingData.LinearModel.Gender are the lowest among these three models. Taken above comparision together, the MarketingData.LinearModel.Gender using Gender as fixed effect is the best model for this dataset. In this dataset, Gender is a fixed effect and Gender is slightly correlated with Time. So MarketingData.LinearModel.Gender using Gender as fixed effect is better than the MarketingData.Probability.Random.Effect model using Gender as random effect or MarketingData.EstimatedLinearModel without parameter of Gender.**