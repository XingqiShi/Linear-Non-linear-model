---
title: "LinearNonLinear_Week5_Xingqi_assignment"
author: "Xingqi"
date: "February 4, 2015"
output: html_document
---

This assignment helps understanding Poisson regression and Negative Binomial regression.
This assignment is due one week from the date shown in the title portion of this document.
This assignment is individual.

Recent outbreak of measles caused debated about necessity of vaccination.

The data file for this project contains CDC data on immunization coverage for MMR for all U.S. states and the national immunization rate.

The data for outbreaks in each state were simulated using the assumption that after vaccination 90% of vaccinated children become immuned.

Another assumption was made that 100% of not immunized people get infected when exposed to the virus.

CDC data on immunization coverage rates

The data for this project are in the file MeaslesImmunizationCoverageAndOutbreaks.csv

Read the data.

```{r}
measles.data<-read.csv(file="MeaslesImmunizationCoverageAndOutbreaks.csv")
measles.data<-as.data.frame(measles.data)
```

#Fit Poisson Regression

Fitting Poisson regression to the measles outbreaks data means fitting the model
log(λ)=β0+β0x,
where x is the coverage variable.

```{r}
measles.poisson.model<-glm(Outbreaks~Coverage,family=poisson,data=measles.data)
names(measles.poisson.model)
```

Linear predictors are ηi=β0+β1xi.

```{r}
measles.poisson.model$linear.predictors
```

Compare the Outbreaks data with the fitted values.

```{r}
rbind(measles.data$Outbreaks,measles.poisson.model$fitted.values)
```

Check that the link in our case is logarithmic.

```{r}
log(measles.poisson.model$fitted.values)
```


```{r}
rbind(measles.poisson.model$linear.predictors,log(measles.poisson.model$fitted.values))
```

The linear predictors and log value of measles.poisson.model$fitted.values are identical.

Interpretation of the model.

**Answer:**
The summary of measles.poisson.model is as below.

```{r}
summary(measles.poisson.model)
```

Both p vlaues of intercept and coverage in this model are significant. The slope of variable Coverage is negative, which means each one percent increasing of Coverage leads to decreasing log intensity ratio of Outbreaks. The Null Deviance is  52.55 while the residual Deviance is 37.55. The proportion of deviance exlained by this model is 1-37.549/52.549= 0.285. 

The residuals are plotted in below. 

```{r message=FALSE}
library(faraway)
halfnorm(residuals(measles.poisson.model))
```

The half-normal plot of the residuals in above figure shows two outliers.

In a poisson distribution, the mean is equal to the variance. I checked the mean and variance of measles.poisson.model as below.

```{r}
plot(log(measles.poisson.model$fitted.values), 
     log((measles.data$Outbreaks-measles.poisson.model$fitted.values)^2), 
     xlab=expression(hat(mu)),ylab=expression((y-hat(mu))^2))
abline(0,1)
```

In this model, majority means are larger than variance. So this model is underdispersion.

What if coverage changes by 1%?

Then the intensity of the Poisson distribution will have relative change
λ1λ2=exp(β1δx),
where δx is the change in coverage.

Let δx=0.01. Then the change of intensity measured in percentage points is

```{r}
(1-exp(measles.poisson.model$coef[2]*.01))*100
```

**Answer:**

The Intensity measured in percentage points is changed 0.7797844 fold when the coverage is changed by 1%. In other words, when the coverage is increased by 1%, the intensity measured in percentage points decrease 0.7797844 fold. When the coverage is decreased by 1%, the intensity measured in percentage points increase 0.7797844 fold.

#Fit Negative Binomial regression

The standard glm() function does not have functionality to fit negative binomial distribution. But the package MASS does have it.
Learn how to use the package to fit negative binomial regression.

```{r message=FALSE, warining=FALSE}
library(MASS)
```

Fit the model using negative binomial regression as below.

```{r}
measles.negativebin.model <- glm(Outbreaks~Coverage, negative.binomial(1),data = measles.data)
summary(measles.negativebin.model)
rbind(measles.negativebin.model=measles.negativebin.model$coef, measles.poisson.model=measles.poisson.model$coef)
```

Interpret the results.

Both p values of intercept and coverage in this model are significant. The slope of variable Coverage is negative, which means each one percent increasing of Coverage leads to decreasing log intensity ratio of Outbreaks. The Null Deviance is  0.42183 while the residual Deviance is 0.30819. The proportion of deviance explained by this model is 1-0.30819/0.42183= 0.2693976, which is close to the proportion in above measles.poisson.model. 

glm.nb in R can allow the parameter k to vary and be estimated using maxium likelihood as below.

```{r warning=FALSE}
measles.negativebin.model2 <- glm.nb(Outbreaks~Coverage, data = measles.data)
summary(measles.negativebin.model2)
```

Interpret the results.

Answer:
The p values of intercept and slop in this model are both statistically significant. The values of intercept and slope are slightly different from above measles.negaticebin.model but are identical to the values in measles.poisson.model.The proportion of deviance explained by this model is 1-37.547/52.547 = 0.2854587, which is close to the proportion in above measles.poisson.model. The AIC value in measles.negativebin.model2 is 402.72, which is slightly higer than AIC value in measles.poisson.model (400.72) and is lower than AIC value in measles.negativebin.model (632.4603).

Compare the fit with the fitted Poisson regression model.

The comparision of coefficiency in different models is as below.

```{r}
rbind(measles.poisson.model=measles.poisson.model$coef, 
      measles.negativebin.model=measles.negativebin.model$coef, 
      measles.negativebin.model2=measles.negativebin.model2$coef)
```

The comparision of AIC in different models is as below.

```{r}
rbind(measles.poisson.model=measles.poisson.model$aic, 
      measles.negativebin.model=measles.negativebin.model$aic, 
      measles.negativebin.model2=measles.negativebin.model2$aic)
```

The comparision of fitted values is as below.

```{r}

measles.data$measles.poisson.model=measles.poisson.model$fitted
measles.data$measles.negativebin.model=measles.negativebin.model$fitted 
measles.data$measles.negativebin.model2=measles.negativebin.model2$fitted
matplot(measles.data[,3:6], type='l',lty=c(1,2,3,4),
        col=c("black","red","green","blue"),lwd=2)
legend("topleft",
       legend=c("measles.data","measles.poisson.model","measles.negativebin.model","measles.negativebin.model2"),
       lty=c(1,2,3,4),
        col=c("black","red","green","blue"),lwd=2)
      
```

From above graph, the predictions from three different models are overlapping with eath other. The difference of predictions is low.

Next, I examine the residuals in these three models.

```{r}
par(mfrow=c(1,3))
qqnorm(measles.poisson.model$residuals,main="measles.poisson.model")
qqline(measles.poisson.model$residual)
qqnorm(measles.negativebin.model$residuals,main="measles.negativebin.model")
qqline(measles.negativebin.model$residual)
qqnorm(measles.negativebin.model2$residuals,main="measles.negativebin.model2")
qqline(measles.negativebin.model2$residual)
```

The pchisq tests of these models are as below. 

```{r}
pchisq(deviance(measles.poisson.model),df.residual(measles.poisson.model),lower=FALSE)
pchisq(deviance(measles.negativebin.model),df.residual(measles.negativebin.model),lower=FALSE)
pchisq(deviance(measles.negativebin.model2),df.residual(measles.negativebin.model2),lower=FALSE)
```

Using pchisq test, all of these three models fit sufficently well.

Take together, the p values of slope and intercept in all three models are all statistically significant. AIC value in measles.poisson.model is slightly lower than measles.negativebin.model2. The predictions from above three models are very close to each other. The QQ plot shows that the residuals in these models share similar pattern. The pchisq test demonstrates the fit of these models is sufficent. From AIC values, measles.poisson.model is the best model for this dataset. The measles.poisson.model is underdispersion. The possion model is the best model for this dataset in this analysis.
